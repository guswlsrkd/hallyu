<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="spr.com.hallyu.admin.mapper.AdminCategoryMapper">

  <resultMap id="CategoryMap" type="spr.com.hallyu.board.model.BoardCategory">
    <id property="code"        column="code"/>
    <result property="name"        column="name"/>
    <result property="path"        column="path"/>
    <result property="sortOrder"   column="sort_order"/>
    <result property="useYn"       column="use_yn"/>
    <result property="visible"     column="visible"/>
    <result property="parentCode"  column="parent_code"/>
    <result property="depth"       column="depth"/>
    <result property="createdAt"   column="created_at"/>
    <result property="updatedAt"   column="updated_at"/>
  </resultMap>

  <select id="findAll" resultMap="CategoryMap">
    SELECT code,name,path,sort_order,use_yn,visible,parent_code,depth,created_at,updated_at
    FROM board_category
    ORDER BY COALESCE(parent_code,''), sort_order, name
  </select>

  <select id="findOne" parameterType="string" resultMap="CategoryMap">
    SELECT code,name,path,sort_order,use_yn,visible,parent_code,depth,created_at,updated_at
    FROM board_category
    WHERE code = #{code}
  </select>

  <select id="findChildren" parameterType="string" resultMap="CategoryMap">
    SELECT code,name,path,sort_order,use_yn,visible,parent_code,depth,created_at,updated_at
    FROM board_category
    WHERE parent_code = #{parentCode}
    ORDER BY sort_order, name
  </select>

  <!-- ★ 문제되던 쿼리: CDATA로 감싸서 <=> 를 안전하게 -->
  <select id="findMaxSortByParent" parameterType="string" resultType="int">
    <![CDATA[
    SELECT COALESCE(MAX(sort_order), 0)
    FROM board_category
    WHERE (parent_code <=> #{parentCode})
    ]]>
  </select>

  <insert id="insert" parameterType="spr.com.hallyu.board.model.BoardCategory">
    INSERT INTO board_category(code,name,path,sort_order,use_yn,visible,parent_code,depth)
    VALUES(#{code},#{name},#{path},#{sortOrder},#{useYn},#{visible},#{parentCode},#{depth})
  </insert>

  <update id="update" parameterType="spr.com.hallyu.board.model.BoardCategory">
    UPDATE board_category
    SET name=#{name}, path=#{path}, sort_order=#{sortOrder},
        use_yn=#{useYn}, visible=#{visible},
        parent_code=#{parentCode}, depth=#{depth}
    WHERE code=#{code}
  </update>

  <delete id="delete" parameterType="string">
    DELETE FROM board_category WHERE code=#{code}
  </delete>

  <update id="updateSort" parameterType="map">
    UPDATE board_category SET sort_order = #{sortOrder} WHERE code = #{code}
  </update>

  <select id="countChildren" parameterType="string" resultType="int">
    SELECT COUNT(*) FROM board_category WHERE parent_code = #{code}
  </select>

</mapper>
