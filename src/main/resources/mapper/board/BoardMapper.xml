<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="spr.com.hallyu.board.mapper.BoardMapper">

  <resultMap id="BoardMap" type="spr.com.hallyu.board.model.BoardPost">
    <id property="id" column="id"/>
    <result property="code" column="code"/>
    <result property="title" column="title"/>
    <result property="content" column="content"/>
    <result property="writer" column="writer"/>
    <result property="viewCnt" column="view_cnt"/>
    <result property="isNotice" column="is_notice"/>
    <result property="createdAt" column="created_at" />
    <result property="updatedAt" column="updated_at"/>
  </resultMap>

  <select id="countByCode" resultType="long">
    SELECT COUNT(*) FROM board_post WHERE code = #{code}
  </select>

  <select id="findPageByCode" resultMap="BoardMap">
    SELECT id, category_code, title, content, writer, view_cnt, is_notice, created_at, updated_at
    FROM board_post
    WHERE code = #{code}
    ORDER BY is_notice DESC, id DESC
    LIMIT #{limit} OFFSET #{offset}
  </select>

  <select id="findOne" parameterType="long" resultMap="BoardMap">
    SELECT id, category_code, title, content, writer, view_cnt, is_notice, created_at, updated_at
    FROM board_post WHERE id = #{id}
  </select>

  <insert id="insertPost" parameterType="spr.com.hallyu.board.model.BoardPost" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO board_post (category_code, title, content, writer, is_notice, view_cnt, created_at)
    VALUES (#{categoryCode}, #{title}, #{content}, #{writer}, false, 0, NOW())
  </insert>

  <update id="updatePost" parameterType="spr.com.hallyu.board.model.BoardPost">
    UPDATE board_post
    SET title = #{title}, content = #{content}, updated_at = NOW()
    WHERE id = #{id}
  </update>

  <delete id="deletePost" parameterType="long">
    DELETE FROM board_post WHERE id = #{id}
  </delete>

  <update id="increaseViews">
    UPDATE board_post SET view_cnt = view_cnt + 1 WHERE id = #{id}
  </update>
  
  <!-- path 로 카테고리 조회 (사용자 라우터용) -->
  <select id="findByPath" parameterType="string"
          resultType="spr.com.hallyu.board.model.BoardCategory">
    SELECT code, name, path, parent_code, depth, sort_order, use_yn, visible
    FROM board_category
    WHERE path = #{path}
      AND use_yn = 'Y'
      AND visible = 'Y'
    LIMIT 1
  </select>

  <!-- code 로 카테고리 조회 (게시판 목록용) -->
  <select id="findByCode" parameterType="string"
          resultType="spr.com.hallyu.board.model.BoardCategory">
    SELECT code, name, path, parent_code, depth, sort_order, use_yn, visible, write_auth
    FROM board_category
    WHERE code = #{code}
    LIMIT 1
  </select>
  
  <!-- ✅ 게시글 목록 조회 -->
  <select id="findPostsByCategory" parameterType="map"
          resultType="spr.com.hallyu.board.model.BoardPost">
    SELECT
      id,
      category_code,
      title,
      writer,
      created_at,
      view_cnt
    FROM board_post
    WHERE category_code = #{categoryCode}
    ORDER BY id DESC
    LIMIT #{limit} OFFSET #{offset}
  </select>

  <!-- ✅ 게시글 개수 -->
  <select id="countPostsByCategory" parameterType="string" resultType="int">
    SELECT COUNT(*)
    FROM board_post
    WHERE category_code = #{categoryCode}
  </select>

</mapper>
